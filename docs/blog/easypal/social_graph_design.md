<p align="right"><b><em>last updated at {docsify-updated}</em></b></p>

### 社图系统设计

#### 1.背景

```
    现公司内容域发展过程中，一直以来避免用户交互，一方面是顾及合规的要求，一方面是内容审核成本的问题。随着业务深入与市场创意等业务需求的不断增多，
对社交因素有了更高的要求，故此需要设计一个专门针对社交图谱优化的系统。

    你和任何一个陌生人之间所间隔的人不会超过六个 -- 六度空间理论
    社交分离度 -- 基于2016年的数据，facebook已经成功将六度空间数值缩小到了4.2
```

#### 2.难点

```
    本系统面向C端用户，以用户检索关系数据为最优先，次一级考虑数据挖掘产生价值。
    1.图数据庞大，关系数据量级超越了实体数据，给存储与检索与响应性能带来了巨大的影响
    2.数据传播(pull & push)
    3.热点数据治理
    4.多租户要求
    5.CDC系统设计
    6.数据挖掘产生价值
    7.社群传播（只有系统提供赋能，内容能识别用户去快速传播）
```

* [基于MongoDB实现的实时数仓](https://www.jianshu.com/p/d05102817eb6)

#### 3.技术调研

```
    调研了facebook、twitter、微博、微信朋友圈、抖音等系统的相关技术设计文档。整体细节设计上，我们缺少技术积累，但是可以站在他们的起点上获得更高
的眼界，其中字节跳动最年轻，技术水平最高，但是技术开发难度过于陡峭，方案并不适合我们公司。结合了我个人的开发经验与公司现状，决定用TAO的模式去开发，
针对场景优化应该会比字节跳动的性能更高，但是不会更通用，通用的图数据库针对场景优化肯定还有很多配置的东西，内容相关的东西对响应其实并不敏感。
```

* [架构解读-Facebook社交图谱TAO](https://zhuanlan.zhihu.com/p/158361250)
* [facebook 架构_facebook系统架构简介](https://blog.csdn.net/weixin_26714375/article/details/108907245)
* [Neo4j基础（详细）](https://www.jianshu.com/p/9e3c4892ab3e)
* [Spark GraphX学习（一）图（GraphX ）简介](https://blog.csdn.net/qq_41851454/article/details/80388443)
* [Gitee Plato](https://gitee.com/mirrors/plato)
* [字节跳动自研万亿级图数据库 & 图计算实践](https://blog.csdn.net/weixin_45825082/article/details/104497449?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-2.control)

#### 4.结论

```
公司社图系统设计要分步骤有目标有规划地去实现。
1.系统现状
    农场正在对好友社群进行一定程度的尝试，但是由于农场本身并没有进行强传播与便利地引导加好友，所以社群功能还是比较简单。目前基于单数据库单表单条数据
实现。得益于云服务对mysql的优化，在qps低于2w，数据量级低于2000w时，数据库依然有强劲的性能表现，如果重推社交属性，数据增长数据会很快。
2.初步收敛
    在系统未完善时，用户关系数据暴涨会导致数据倾斜与数据传播性能极度降低，故此阶段关系数据数量设置上限，进行缓存设计与接口收敛，数据传播使用热点推送
模式。
3.功能优化
    此阶段要针对场景进行分别优化，动态、朋友圈、附近、问答、帖子等诸如此类的功能，数据传播使用拉取模式，个人数据使用time_line维护。
4.热点数据治理逻辑
    此阶段扩大关系数据数量上限、允许超大规模关系网产生、此时数据传播使用推拉结合模式，对关系网设置组模式管理，针对量级选择推拉模式，防止热数据对系统
造成影响。
5.数仓产生价值
    全阶段数仓均可介入，多个阶段视情况可以跳过或者联合进行开发。核心为CDC产生反向关系数据优化查询、组关系治理优化大型关系网，GraphX进行数仓图数据查询。
```

#### 5.设计目标

```
    为公司电商系统进行内容与社交赋能。数据分片先行，同时进行顶层接口缓存设计，以便于进行下一步的优化，视业务发展而定。
```

#### 6.详细设计

```
1.数据库

    数据库层面考虑事务性不强、承载能力要求较高、容量扩容会有周期性要求，这种情况下用mongo要好于mysql
    鉴于我司mongo生产版本使用3.2用4.0版本，联合索引不支持哈希索引，且常用ID基于ObjectId，哈希索引并不明示，故而考虑使用业务ID使用一致性HASH算
法计算出一个分片平衡shardId再进行分片，点使用shardId哈希索引分片，边使用shardId、shardTime联合自增索引进行分片，shardTime基本选择点的创建时间
    数据面向用户访问优化，如果有反差需求则通过建设CDC总线解决，基于Debezium或者现有数仓kudu来进行支持
    数据扩散采用队列异步处理，防止写入量过大

2.缓存

    本身mongo是一个高效使用内存的数据库，其次考虑关系数据顶层设计基于远程缓存redis实现，业务相关数据可以可以按照用户行为聚合为一些高效索引结构序
列化做远程缓存，热点数据结合推模式做策略置热，使用本地与远程多级缓存，通过队列广播置热，提高响应。由于大部分数据都是用户产生数据，主动feed会消耗较
多资源，所以缓存主力采用硬盘缓存方式cache aside pattern，即用户数据发生变更了都删掉用户的数据重新去数据库获取。

3.基础服务

    基于顶层设计，进行多租户设计与功能物理隔离，桥接模式为业务利用顶层代码，实现专门优化的关系图谱服务，赋能电商与内容线，全部功能基于响应式开发，
确保大部分io耗时阻塞耗时能够去除。

4.租户聚合

    租户不用关心底层设计，可获得关系存储、高效查询、关系数据挖掘与推荐等优势。

```

* [MongoDB分片（Sharding）技术](http://ddrv.cn/a/564642)
* [MongoDB 分片键的选择与案例](https://www.cnblogs.com/chenmh/p/8954584.html)
* [核心演示代码路径](social-graph-service/src/main/java/com/ddmc/social/graph/service/common/support/graph)
